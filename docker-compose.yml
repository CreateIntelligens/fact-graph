services:
  # Nginx åå‘ä»£ç† - çµ±ä¸€å…¥å£
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: fact-graph-nginx
    ports:
      - "8897:8897"  # å°å¤–çµ±ä¸€ç«¯å£
    depends_on:
      - fact-graph
      - llm-api
    networks:
      - fact-graph-network

  # Fact Graph æ ¸å¿ƒæœå‹™
  fact-graph:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: irs-fact-graph
    expose:
      - "8897"  # åªå°å…§éƒ¨ç¶²è·¯é–‹æ”¾
    volumes:
      - ./:/fact-graph
    working_dir: /fact-graph
    stdin_open: true
    tty: true
    networks:
      - fact-graph-network
    command: |
      bash -c "
        set -euo pipefail
        echo '========================================='
        echo 'IRS Fact Graph - ç¾åœ‹ç¨…å‹™çŸ¥è­˜åœ–è­œ'
        echo '========================================='
        echo ''
        echo 'æ­£åœ¨ç·¨è­¯ ScalaJS æ¨¡çµ„ (sbt fastOptJS)...'
        echo ''
        sbt fastOptJS
        cp js/target/scala-*/factgraph-fastopt/main.mjs demo/fg.js
        echo ''
        echo 'ç·¨è­¯å®Œæˆï¼Œå•Ÿå‹• Demo ä¼ºæœå™¨...'
        echo ''
        echo 'è¨ªå•: http://localhost:8897'
        echo ''
        echo 'ä½¿ç”¨æ–¹å¼:'
        echo '1. é–‹å•Ÿç€è¦½å™¨è¨ªå• http://localhost:8897'
        echo '2. é»æ“Šã€ŒLoad Fact Dictionaryã€'
        echo '3. é¸æ“‡ all-facts.xml æª”æ¡ˆ'
        echo '4. é–‹å§‹æŸ¥è©¢ç¨…å‹™è¦å‰‡!'
        echo ''
        echo '========================================='
        cd demo && python3 -m http.server 8897
      "

  # LLM API æœå‹™
  llm-api:
    build:
      context: .
      dockerfile: Dockerfile.llm
    container_name: fact-graph-llm-api
    expose:
      - "8000"  # åªå°å…§éƒ¨ç¶²è·¯é–‹æ”¾
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - FACT_GRAPH_URL=http://fact-graph:8897
    volumes:
      - ./llm-integration:/app
      - ./demo:/fact-graph/demo
    working_dir: /app
    depends_on:
      - fact-graph
    networks:
      - fact-graph-network
    command: |
      bash -c "
        echo '========================================='
        echo 'ğŸ¤– LLM API æœå‹™å•Ÿå‹•ä¸­...'
        echo '========================================='
        echo ''
        echo 'API ç«¯é»: http://localhost:8000'
        echo 'API æ–‡æª”: http://localhost:8000/docs'
        echo 'èŠå¤©ç•Œé¢: http://localhost:8000/chat'
        echo ''
        echo '========================================='
        python api_server.py
      "

networks:
  fact-graph-network:
    driver: bridge
